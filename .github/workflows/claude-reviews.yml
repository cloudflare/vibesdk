name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  comprehensive-review:
    name: PR Description & Code Review
    if: |
      github.event.pull_request.user.login != 'dependabot[bot]' &&
      !contains(github.event.pull_request.title, 'Release') &&
      github.event.pull_request.head.repo.full_name == github.repository

    runs-on: ubuntu-latest

    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    env:
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      ANTHROPIC_CUSTOM_HEADERS: ${{ secrets.ANTHROPIC_CUSTOM_HEADERS }}

    steps:
      - name: Cleanup previous Claude workflow comments
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_IDS=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --paginate --jq '.[] | select(.user.login == "github-actions[bot]") | select(.body | (contains("Claude encountered an error") or contains("Claude finished") or contains("Code Review for PR")) and contains("View job")) | .id')
          if [ -z "$COMMENT_IDS" ]; then
            echo "No previous Claude comments to delete."
            exit 0
          fi

          echo "$COMMENT_IDS" | while read -r comment_id; do
            echo "Deleting comment $comment_id"
            gh api repos/${{ github.repository }}/issues/comments/$comment_id -X DELETE
          done

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Critical Paths
        id: critical_paths
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CRITICAL_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --name-only | grep -E "^(worker/api/|worker/database/|worker/config/|shared/types/)" || true)
          if [ -n "$CRITICAL_FILES" ]; then
            echo "is_critical=true" >> $GITHUB_OUTPUT
          else
            echo "is_critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Comprehensive Review
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          track_progress: true
          prompt: |
            ${{ steps.critical_paths.outputs.is_critical == 'true' && 'ðŸ”’ **CRITICAL PATH SECURITY REVIEW**

            This PR modifies security-sensitive files in worker/api/, worker/database/, worker/config/, or shared/types/.
            Perform DEEP security analysis with extra scrutiny.

            ' || '' }}Update PR description (if needed) and perform comprehensive code review for PR #${{ github.event.pull_request.number }}.

            WORKFLOW:
            1. Read `CLAUDE.md` for project conventions (use the Read tool).
            2. Get PR diff with: `gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }}`
            3. Review for:
               - Bugs, edge cases, regressions
               - Type safety issues (no 'any')
               - Security issues (authz, injection, data exposure)
               - Performance pitfalls
               - Missing tests
            4. Post a single summary comment via:
               `gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body "..."`

          claude_args: |
            --system-prompt "You are reviewing code for a Cloudflare Workers application. Focus on exploitable runtime issues in worker/, src/, shared/."
            --allowed-tools "Read,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),Bash(gh pr edit:*)"
            --max-turns ${{ steps.critical_paths.outputs.is_critical == 'true' && '80' || '50' }}
            --model claude-opus-4-5-20251101

